image: mambaorg/micromamba:latest

before_script:
  - mkdir ./conda/
  - conda config --add pkgs_dirs ./conda/pkgs/
  - micromamba env create --prefix ./conda/stenv/ -f environment.yaml
  - micromamba activate ./conda/stenv/

build:
  stage: build
  cache:
    - key:
        files:
          - environment.yaml
      paths:
        - ./conda/
  parallel:
    matrix:
      - PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
  tags:
    - $RUNNER
  script:
    - micromamba install python=$PYTHON conda
    - conda env export --no-build | grep -v "name:" | grep -v "prefix:"
    - pytest -n auto tests/test_import.py

unit-tests:
  stage: test
  cache:
    - key:
        files:
          - environment.yaml
      paths:
        - ./conda/
  parallel:
    matrix:
      - PACKAGE: acstools
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        EXTRAS: ["test"]
      - PACKAGE: asdf
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        EXTRAS: ["tests"]
      - PACKAGE: ccdproc
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        EXTRAS: ["test"]
      - PACKAGE: costools
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
      - PACKAGE: reftools
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        EXTRAS: ["test"]
      - PACKAGE: synphot
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        EXTRAS: ["test"]
      - PACKAGE: wfpc2tools
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
  tags:
    - $RUNNER
  script:
    - pip install $PACKAGE$EXTRAS
    - pytest -n auto --pyargs $PACKAGE

unit-tests-from-source:
  stage: test
  cache:
    - key:
        files:
          - environment.yaml
      paths:
        - ./conda/
  parallel:
    matrix:
      - PACKAGE: calcos
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        REPOSITORY: https://github.com/spacetelescope/calcos
      #- PACKAGE: crds
      #  PYTHON: ["3.9", "3.10", "3.11"]
      #  RUNNER: ["test"]
      #  REPOSITORY: https://github.com/spacetelescope/crds
      #  EXTRAS: [ test ]
      #  env:
      #    CRDS_SERVER_URL: https://hst-crds.stsci.edu
      #  pre_command: './setup_test_cache $HOME && source envs/hst-crds-ops.sh'
      #- PACKAGE: drizzlepac
      #  PYTHON: ["3.9", "3.10", "3.11"]
      #  RUNNER: ["test"]
      #  REPOSITORY: https://github.com/spacetelescope/drizzlepac
      #  EXTRAS: [ test ]
      - PACKAGE: hstcal
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        REPOSITORY: https://github.com/spacetelescope/hstcal
        pytest_args: '--slow'
        test_directory: tests
        env:
          CRDS_SERVER_URL: https://hst-crds.stsci.edu
      - PACKAGE: jwst
        PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
        REPOSITORY: https://github.com/spacetelescope/jwst
        extras: [ test ]
        pytest_args: '--slow -k "not test_cmdline_status"'
        env:
          CRDS_SERVER_URL: https://jwst-crds.stsci.edu
  tags:
    - $RUNNER
  script:
    - pip install -e .$EXTRAS

smoke-tests:
  stage: test
  cache:
    - key:
        files:
          - environment.yaml
      paths:
        - ./conda/
  parallel:
    matrix:
      - PYTHON: ["3.9", "3.10", "3.11"]
        RUNNER: ["test"]
  tags:
    - $RUNNER
  script:
    - echo "TODO smoke tests"

export:
  stage: deploy
  script:
    - echo "TODO export yaml files"
  environment: production
